<!DOCTYPE html>
<html>

<head>
    <title>Itowns - postprocessing</title>

    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/example.css">
    <link rel="stylesheet" type="text/css" href="css/LoadingScreen.css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div id="viewerDiv"></div>
    <script src="../dist/itowns.js"></script>
    <script src="js/GUI/LoadingScreen.js"></script>

    <script type="x-shader/x-fragment" id="coastSharpenFragmentShader">
        uniform float uWeight;
        uniform vec2 uOffset;

        float getAvg(vec2 uv) {
            vec4 color = texture2D(uTexture, uv);
            return (color.r + color.g + color.b) / 3.0;
        }

        void main() {
            vec4 color = texture2D( uTexture, vUv );

            float mid = getAvg(vUv);
            float left = getAvg(vUv - uOffset);

            float diff = uWeight * (mid - left);
            float avg = (mid + left) / 2.0;

            float smoothed = max(0., diff - avg);

            gl_FragColor = color + vec4(smoothed, smoothed, smoothed, 1.0);
        }
    </script>
    <script type="x-shader/x-fragment" id="greyscaleFragmentShader">
        void main() {
            vec4 color = texture2D( uTexture, vUv );
            float avg = (color.r + color.g + color.b) / 3.;
            gl_FragColor = vec4(avg, avg, avg, 1.0);
        }
    </script>

    <script type="text/javascript">
        var placement = {
            coord: new itowns.Coordinates('EPSG:4326', 2.351323, 48.856712),
            range: 25000000,
        }
        // iTowns namespace defined here
        var viewerDiv = document.getElementById('viewerDiv');
        var view = new itowns.GlobeView(viewerDiv, placement);

        setupLoadingScreen(viewerDiv, view);

        // Graph showcase
        const outerGraph = new itowns.Graph();

        const inputView = new itowns.InputNode(view);
        const renderer = new itowns.InputNode(view.mainLoop.gfxEngine.renderer);
        const render = new itowns.RenderViewNode(inputView);
        outerGraph.setGrouped({inputView, renderer, render});

        // Subgraphs
        const postProcessingGraph = new itowns.Graph();
        // Sobel sharpen
        // Uniforms
        const sharpenWeight = new itowns.InputNode(5);
        const sharpenOffset = new itowns.InputNode(new itowns.THREE.Vector2(0.0025, 0.));
        postProcessingGraph.setGrouped({sharpenWeight, sharpenOffset});
        // Screen shaders
        const coastSharpen = new itowns.ScreenShaderNode(render, renderer, {
            fragmentShader: document.getElementById('coastSharpenFragmentShader').textContent,
            uniforms: {uWeight: sharpenWeight, uOffset: sharpenOffset},
        });
        const greyscale = new itowns.ScreenShaderNode(coastSharpen, renderer, {
            fragmentShader: document.getElementById('greyscaleFragmentShader').textContent,
            toScreen: true,
        });
        postProcessingGraph.setGrouped({coastSharpen, greyscale});

        const postProcessingGraphNode = new itowns.SubGraphNode(outerGraph, postProcessingGraph, greyscale, 'Post-processing');
        outerGraph.setGrouped({postProcessingGraphNode});

        console.log(coastSharpen.inputs.get('input'))

        console.dir(outerGraph);
        console.log(outerGraph.dumpDot());
        // window.open(outerGraph.dumpDotGraphvizLink(), '_blank');

        let frame = 0;
        view.render = function render() {
            outerGraph.getOutput(frame++, postProcessingGraphNode);
        };

        itowns.Fetcher.json('./layers/JSONLayers/Ortho.json').then(function _(config) {
            config.source = new itowns.WMTSSource(config.source);
            var layer = new itowns.ColorLayer('Ortho', config);
            view.addLayer(layer);
        });
        itowns.Fetcher.json('./layers/JSONLayers/IGN_MNT.json').then(function _(config) {
            config.source = new itowns.WMTSSource(config.source);
            var layer = new itowns.ElevationLayer(config.id, config);
            view.addLayer(layer);
        });
    </script>
</body>

</html>
