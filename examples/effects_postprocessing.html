<!DOCTYPE html>
<html>

<head>
    <title>Itowns - postprocessing</title>

    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/example.css">
    <link rel="stylesheet" type="text/css" href="css/LoadingScreen.css">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <div id="viewerDiv"></div>
    <script src="../dist/itowns.js"></script>
    <script src="js/GUI/LoadingScreen.js"></script>

    <script type="x-shader/x-fragment" id="coastSharpenFragmentShader">
        float getAvg(vec2 uv) {
            vec4 color = texture2D(uTexture, uv);
            return (color.r + color.g + color.b) / 3.0;
        }

        void coastSharpen() {
            vec4 color = texture2D( uTexture, vUv );

            float mid = getAvg(vUv);
            float left = getAvg(vUv - uOffset);

            float diff = uWeight * (mid - left);
            float avg = (mid + left) / 2.0;

            float smoothed = max(0., diff - avg);

            gl_FragColor = color + vec4(smoothed, smoothed, smoothed, 1.0);
        }
    </script>
    <script type="x-shader/x-fragment" id="greyscaleFragmentShader">
        void greyscale() {
            vec4 color = texture2D( uTexture, vUv );
            float avg = (color.r + color.g + color.b) / 3.;
            gl_FragColor = vec4(avg, avg, avg, 1.0);
        }
    </script>

    <script type="text/javascript">
        const graph = itowns.graph;

        // Graph showcase
        const outerGraph = new graph.Graph();

        // iTowns namespace defined here
        const placement = new graph.InputNode({
            coord: new itowns.Coordinates('EPSG:4326', 2.351323, 48.856712),
            range: 25_000_000,
        }, graph.BuiltinType.Placement);
        const viewerDiv = new graph.InputNode(document.getElementById('viewerDiv'));
        const viewNode = new graph.GlobeViewNode(viewerDiv, placement);
        outerGraph.setGrouped({placement, viewerDiv, viewNode});

        // window.open(outerGraph.dumpDotGraphvizLink(), '_blank');

        console.log(viewNode);
        const div = viewerDiv.getOutput();
        const view = viewNode.getOutput('view', outerGraph);
        setupLoadingScreen(div, view);

        // const renderer = new graph.InputNode(view.mainLoop.gfxEngine.renderer);
        const renderer = {node: viewNode, output: 'renderer'};
        const render = new graph.RenderViewNode({node: viewNode, output: 'view'});
        outerGraph.setGrouped({render});

        // Subgraph
        const postProcessingGraph = new graph.Graph();
        // Sobel sharpen
        // Uniforms
        const sharpenWeight = new graph.InputNode(5);
        const sharpenOffset = new graph.InputNode(new itowns.THREE.Vector2(0.0025, 0.));
        postProcessingGraph.setGrouped({sharpenWeight, sharpenOffset});
        // Screen shaders
        const coastSharpen = new graph.ScreenShaderNode(render, renderer, {
            fragmentShader: {
                uniforms: {uWeight: sharpenWeight, uOffset: sharpenOffset},
                code: document.getElementById('coastSharpenFragmentShader').textContent,
                entry: 'coastSharpen'
            },
        });
        const greyscale = new graph.ScreenShaderNode(coastSharpen, renderer, {
            fragmentShader: {
                code: document.getElementById('greyscaleFragmentShader').textContent,
                entry: 'greyscale'
            },
            toScreen: true,
        });
        postProcessingGraph.setGrouped({coastSharpen, greyscale});

        const postProcessingGraphNode = new graph.SubGraphNode(outerGraph, graph.SubGraph.from(postProcessingGraph, 'Post-processing'), {
            greyscale: {
                node: greyscale,
                output: 'value',
            }
        });
        outerGraph.setGrouped({postProcessingGraphNode});

        // window.open(outerGraph.dumpDotGraphvizLink(), '_blank');

        let frame = 0;
        view.render = function render() {
            outerGraph.getOutput(frame++, {node: postProcessingGraphNode, output: 'greyscale'});
        };

        itowns.Fetcher.json('./layers/JSONLayers/Ortho.json').then(function _(config) {
            config.source = new itowns.WMTSSource(config.source);
            var layer = new itowns.ColorLayer('Ortho', config);
            view.addLayer(layer);
        });
        itowns.Fetcher.json('./layers/JSONLayers/IGN_MNT.json').then(function _(config) {
            config.source = new itowns.WMTSSource(config.source);
            var layer = new itowns.ElevationLayer(config.id, config);
            view.addLayer(layer);
        });
    </script>
</body>

</html>
